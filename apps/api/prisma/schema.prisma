// Prisma schema for MAAC experimental database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core experimental data table
model MAACExperimentalData {
  id Int @id @default(autoincrement())

  // Research identifiers
  experimentId String @map("experiment_id")
  sessionId    String @map("session_id") @db.Uuid
  trialId      String @map("trial_id") @unique
  configId     String @map("config_id")
  domain       String
  tier         String
  repetition   Int
  modelId      String @map("model_id")

  // Tool configuration
  enabledTools String[] @map("enabled_tools")
  toolCount    Int      @map("tool_count")

  goalEngineEnabled         Boolean @map("goal_engine_enabled")
  planningEngineEnabled     Boolean @map("planning_engine_enabled")
  clarificationEngineEnabled Boolean @map("clarification_engine_enabled")
  validationEngineEnabled   Boolean @map("validation_engine_enabled")
  evaluationEngineEnabled   Boolean @map("evaluation_engine_enabled")
  reflectionEngineEnabled   Boolean @map("reflection_engine_enabled")
  memoryStoreEnabled        Boolean @map("memory_store_enabled")
  memoryNodeQueryEnabled    Boolean @map("memory_node_query_enabled")
  memoryContextQueryEnabled Boolean @map("memory_context_query_enabled")
  memoryEvalQueryEnabled    Boolean @map("memory_eval_query_enabled")
  memoryReflQueryEnabled    Boolean @map("memory_refl_query_enabled")
  thinkToolEnabled          Boolean @map("think_tool_enabled")

  // Response data
  mimicResponseText    String  @map("mimic_response_text") @db.Text
  wordCount            Int     @map("word_count")
  processingMetadata   Json    @map("processing_metadata")
  cognitiveCyclesCount Int     @map("cognitive_cycles_count")
  memoryOperationsCount Int    @map("memory_operations_count")
  toolsInvokedCount    Int     @map("tools_invoked_count")
  processingMethod     String? @map("processing_method")
  complexityAssessment String? @map("complexity_assessment")
  processingTime       Int     @map("processing_time") // milliseconds

  // MAAC Nine-Dimensional Assessment
  maacCognitiveLoad        Decimal? @map("maac_cognitive_load") @db.Decimal(5, 2)
  maacToolExecution        Decimal? @map("maac_tool_execution") @db.Decimal(5, 2)
  maacContentQuality       Decimal? @map("maac_content_quality") @db.Decimal(5, 2)
  maacMemoryIntegration    Decimal? @map("maac_memory_integration") @db.Decimal(5, 2)
  maacComplexityHandling   Decimal? @map("maac_complexity_handling") @db.Decimal(5, 2)
  maacHallucinationControl Decimal? @map("maac_hallucination_control") @db.Decimal(5, 2)
  maacKnowledgeTransfer    Decimal? @map("maac_knowledge_transfer") @db.Decimal(5, 2)
  maacProcessingEfficiency Decimal? @map("maac_processing_efficiency") @db.Decimal(5, 2)
  maacConstructValidity    Decimal? @map("maac_construct_validity") @db.Decimal(5, 2)
  maacOverallScore         Decimal? @map("maac_overall_score") @db.Decimal(5, 2)
  maacConfidence           Decimal? @map("maac_confidence") @db.Decimal(3, 2)

  // Statistical metadata
  statisticalSignificanceP Decimal? @map("statistical_significance_p") @db.Decimal(10, 8)
  effectSizeCohenD         Decimal? @map("effect_size_cohens_d") @db.Decimal(5, 3)
  confidenceInterval95     Json?    @map("confidence_interval_95")

  // Status tracking
  maacCompleted       Boolean   @default(false) @map("maac_completed")
  publicationReady    Boolean   @default(false) @map("publication_ready")
  tier2ComparativeReady Boolean @default(false) @map("tier2_comparative_ready")

  // Tier 2 batch processing
  tier2BatchProcessed Boolean   @default(false) @map("tier2_batch_processed")
  tier2BatchId        String?   @map("tier2_batch_id")
  tier2ProcessedAt    DateTime? @map("tier2_processed_at")
  tier2BatchNumber    Int?      @map("tier2_batch_number")
  tier2AnalysisStatus String    @default("pending") @map("tier2_analysis_status")

  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  mimicStartedAt    DateTime? @map("mimic_started_at")
  mimicCompletedAt  DateTime? @map("mimic_completed_at")

  @@index([experimentId])
  @@index([sessionId])
  @@index([trialId])
  @@index([configId])
  @@index([domain, tier])
  @@index([modelId])
  @@index([maacCompleted])
  @@index([publicationReady])
  @@map("maac_experimental_data")
}

// =============================================================================
// EXPERIMENT TRACKING MODEL
// =============================================================================

model Experiment {
  id            Int      @id @default(autoincrement())
  experimentId  String   @unique @map("experiment_id")
  name          String
  description   String?
  status        String   @default("pending")
  
  // Configuration arrays
  domains       String[]
  tiers         String[]
  models        String[]
  
  // Tool configurations (JSON for flexibility)
  toolConfigs   Json     @map("tool_configs")
  
  // Trial settings
  repetitionsPerDomainTier Int @default(1) @map("repetitions_per_domain_tier")
  parallelism              Int @default(10)
  timeout                  Int @default(60000)
  totalTrials              Int @map("total_trials")
  completedTrials          Int @default(0) @map("completed_trials")
  failedTrials             Int @default(0) @map("failed_trials")
  
  // Timestamps
  createdAt    DateTime  @default(now()) @map("created_at")
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  
  @@index([experimentId])
  @@index([status])
  @@index([createdAt])
  @@map("experiments")
}

model Scenario {
  id              String   @id @default(cuid())
  scenarioId      String   @unique @map("scenario_id")
  domain          String
  tier            String
  taskTitle       String   @map("task_title")
  taskDescription String?  @map("task_description")
  expectedOutcome String?  @map("expected_outcome")
  metadata        Json?
  createdAt       DateTime @default(now()) @map("created_at")
  
  @@index([domain])
  @@index([tier])
  @@index([scenarioId])
  @@map("scenarios")
}

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  encrypted Boolean  @default(false)
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([key])
  @@map("settings")
}

// Scenario definitions
model MAACExperimentScenario {
  id Int @id @default(autoincrement())

  experimentId String @map("experiment_id")
  scenarioId   String @map("scenario_id") @unique
  domain       String
  tier         String
  repetition   Int
  configId     String @map("config_id")
  modelId      String @map("model_id")

  // Task definition
  taskTitle       String @map("task_title")
  taskDescription String @map("task_description") @db.Text
  businessContext String @map("business_context") @db.Text

  // Success criteria (BLIND - not given to LLM)
  successCriteria      Json   @map("success_criteria")
  expectedCalculations Json   @map("expected_calculations")
  expectedInsights     Json   @map("expected_insights")
  scenarioRequirements Json   @map("scenario_requirements")
  dataElements         Json?  @map("data_elements")

  // ============================================================================
  // COMPLEXITY VALIDATION (Academic frameworks)
  // Based on Wood (1986), Campbell (1988), Liu & Li (2012)
  // ============================================================================

  // Validation status
  validationPassed      Boolean   @default(false) @map("validation_passed")
  validationTimestamp   DateTime? @map("validation_timestamp")
  validationDurationMs  Int?      @map("validation_duration_ms")
  regenerationAttempts  Int       @default(0) @map("regeneration_attempts")

  // Composite complexity score
  complexityOverallScore  Decimal? @map("complexity_overall_score") @db.Decimal(5, 2)
  complexityPredictedTier String?  @map("complexity_predicted_tier") // 'simple' | 'moderate' | 'complex'
  complexityTierMatch     Boolean? @map("complexity_tier_match")
  complexityConfidence    Decimal? @map("complexity_confidence") @db.Decimal(3, 2)

  // Wood (1986) metrics
  woodDistinctActs          Int?     @map("wood_distinct_acts")
  woodInformationCuesPerAct Decimal? @map("wood_information_cues_per_act") @db.Decimal(4, 2)
  woodTotalElements         Int?     @map("wood_total_elements")
  woodCoordinativeComplexity String? @map("wood_coordinative_complexity") // 'sequential' | 'interdependent' | 'networked'
  woodDynamicComplexity     String?  @map("wood_dynamic_complexity") // 'static' | 'low' | 'high'
  woodComponentScore        Decimal? @map("wood_component_score") @db.Decimal(5, 2)

  // Campbell (1988) attributes
  campbellMultiplePaths           Boolean? @map("campbell_multiple_paths")
  campbellPathCount               Int?     @map("campbell_path_count")
  campbellMultipleOutcomes        Boolean? @map("campbell_multiple_outcomes")
  campbellOutcomeCount            Int?     @map("campbell_outcome_count")
  campbellConflictingInterdep     Boolean? @map("campbell_conflicting_interdep")
  campbellUncertaintyLevel        String?  @map("campbell_uncertainty_level") // 'none' | 'bounded' | 'high'
  campbellType                    Int?     @map("campbell_type") // 0-15 binary encoding

  // Liu & Li (2012) dimensions
  liuLiSize             Int?     @map("liu_li_size")
  liuLiVariety          Decimal? @map("liu_li_variety") @db.Decimal(3, 2)
  liuLiAmbiguity        Decimal? @map("liu_li_ambiguity") @db.Decimal(3, 2)
  liuLiRelationships    Decimal? @map("liu_li_relationships") @db.Decimal(3, 2)
  liuLiVariability      Decimal? @map("liu_li_variability") @db.Decimal(3, 2)
  liuLiUnreliability    Decimal? @map("liu_li_unreliability") @db.Decimal(3, 2)
  liuLiNovelty          String?  @map("liu_li_novelty") // 'routine' | 'semi-familiar' | 'novel'
  liuLiIncongruity      Decimal? @map("liu_li_incongruity") @db.Decimal(3, 2)
  liuLiActionComplexity Int?     @map("liu_li_action_complexity")
  liuLiTimePressure     String?  @map("liu_li_time_pressure") // 'low' | 'moderate' | 'high'

  // Element interactivity (Cognitive Load Theory)
  interactivityTotalElements      Int?     @map("interactivity_total_elements")
  interactivitySimultaneousElems  Int?     @map("interactivity_simultaneous_elems")
  interactivityRatio              Decimal? @map("interactivity_ratio") @db.Decimal(3, 2)
  interactivityDependencyDepth    Int?     @map("interactivity_dependency_depth")
  interactivityDependencyEdges    Int?     @map("interactivity_dependency_edges")

  // Score breakdown
  scoreWood            Decimal? @map("score_wood") @db.Decimal(5, 2)
  scoreCampbell        Decimal? @map("score_campbell") @db.Decimal(5, 2)
  scoreLiuLi           Decimal? @map("score_liu_li") @db.Decimal(5, 2)
  scoreInteractivity   Decimal? @map("score_interactivity") @db.Decimal(5, 2)

  // Validation flags (stored as JSON for flexibility)
  validationFlags      Json?    @map("validation_flags")
  rejectionReasons     String[] @map("rejection_reasons")
  analyzerVersion      String?  @map("analyzer_version")

  // Full complexity score JSON (for detailed analysis)
  complexityScoreJson  Json?    @map("complexity_score_json")

  // ============================================================================

  // Billing fields
  userId           String? @map("user_id")
  user             User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  apiKeyMode       String  @default("system") @map("api_key_mode") // "own" or "system"
  creditsUsed      Int     @default(0) @map("credits_used") // Total credits consumed
  estimatedCredits Int?    @map("estimated_credits") // Pre-run estimate

  // Status
  completed Boolean   @default(false)
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([experimentId])
  @@index([scenarioId])
  @@index([userId])
  @@index([domain, tier])
  @@index([configId])
  @@index([validationPassed])
  @@index([complexityPredictedTier])
  @@map("maac_experiment_scenarios")
}

// Tier 2 statistical analysis
model MAACTier2Analysis {
  id Int @id @default(autoincrement())

  sessionId               String   @map("session_id") @db.Uuid
  analysisTimestamp       DateTime @default(now()) @map("analysis_timestamp")
  maacFrameworkVersion    String   @default("nine_dimensional_v1.0") @map("maac_framework_version")
  experimentsAnalyzed     Int      @map("experiments_analyzed")
  analysisBatchId         String   @map("analysis_batch_id")
  batchNumber             Int      @map("batch_number")
  batchSize               Int      @default(500) @map("batch_size")

  // Statistical results
  coreStatistics     Json @map("core_statistics")
  advancedStatistics Json @map("advanced_statistics")

  // Multi-agent analysis results
  businessAnalysis            Json @map("business_analysis")
  cognitiveArchitectureAnalysis Json @map("cognitive_architecture_analysis")
  experimentalDesignValidation Json @map("experimental_design_validation")
  synthesisResults            Json @map("synthesis_results")

  // Quality metadata
  dataQualityScore         Decimal? @map("data_quality_score") @db.Decimal(3, 2)
  analysisConfidenceLevel  Decimal? @map("analysis_confidence_level") @db.Decimal(3, 2)
  analysisQualityValidated Boolean  @default(false) @map("analysis_quality_validated")

  // Agent completion tracking
  coreStatisticalAgentCompleted Boolean @default(false) @map("core_statistical_agent_completed")
  advancedStatisticalAgentCompleted Boolean @default(false) @map("advanced_statistical_agent_completed")
  businessAnalysisAgentCompleted Boolean @default(false) @map("business_analysis_agent_completed")
  cognitiveArchitectureAgentCompleted Boolean @default(false) @map("cognitive_architecture_agent_completed")
  experimentalDesignAgentCompleted Boolean @default(false) @map("experimental_design_agent_completed")
  synthesisAgentCompleted Boolean @default(false) @map("synthesis_agent_completed")

  // Publication
  readyForPublication Boolean @default(false) @map("ready_for_publication")

  @@index([sessionId])
  @@index([analysisBatchId])
  @@index([batchNumber])
  @@index([readyForPublication])
  @@map("maac_tier2_analysis")
}

// Statistical summaries for publication
model MAACStatisticalSummary {
  id Int @id @default(autoincrement())

  analysisType  String @map("analysis_type")
  analysisScope String @map("analysis_scope")

  // Sample information
  sampleSize         Int      @map("sample_size")
  experimentCount    Int      @map("experiment_count")
  configurationCount Int      @map("configuration_count")
  domainCoverage     String[] @map("domain_coverage")

  // Statistical results
  meanScore                  Decimal @map("mean_score") @db.Decimal(5, 2)
  standardDeviation          Decimal @map("standard_deviation") @db.Decimal(5, 2)
  confidenceInterval95Lower  Decimal @map("confidence_interval_95_lower") @db.Decimal(5, 2)
  confidenceInterval95Upper  Decimal @map("confidence_interval_95_upper") @db.Decimal(5, 2)
  pValue                     Decimal @map("p_value") @db.Decimal(10, 8)
  effectSize                 Decimal @map("effect_size") @db.Decimal(5, 3)
  statisticalPower           Decimal @map("statistical_power") @db.Decimal(3, 2)

  // MAAC framework validation
  frameworkReliabilityAlpha   Decimal? @map("framework_reliability_alpha") @db.Decimal(3, 2)
  interDimensionalCorrelation Json?    @map("inter_dimensional_correlation")
  constructValidityScore      Decimal? @map("construct_validity_score") @db.Decimal(3, 2)
  predictiveValidityR2        Decimal? @map("predictive_validity_r2") @db.Decimal(3, 2)

  // Research insights
  keyFindings         String[] @map("key_findings")
  methodologicalNotes String?  @map("methodological_notes") @db.Text
  limitations         String[] @map("limitations")

  // Publication metadata
  analysisTimestamp DateTime @default(now()) @map("analysis_timestamp")
  analystNotes      String?  @map("analyst_notes") @db.Text
  publicationReady  Boolean  @default(false) @map("publication_ready")

  @@index([analysisType])
  @@index([publicationReady])
  @@map("maac_statistical_summary")
}

// Academic reports
model MAACAcademicReport {
  id Int @id @default(autoincrement())

  sessionId        String   @map("session_id") @db.Uuid
  reportType       String   @map("report_type")
  reportTimestamp  DateTime @default(now()) @map("report_timestamp")

  // Report content
  introductionSection String @map("introduction_section") @db.Text
  methodologySection  String @map("methodology_section") @db.Text
  resultsSection      String @map("results_section") @db.Text
  discussionSection   String @map("discussion_section") @db.Text
  conclusionSection   String @map("conclusion_section") @db.Text
  referencesSection   String @map("references_section") @db.Text

  // Metadata
  dataQualityScore        Decimal @map("data_quality_score") @db.Decimal(3, 2)
  reportQualityScore      Decimal @map("report_quality_score") @db.Decimal(3, 2)
  literatureRelevanceScore Decimal @map("literature_relevance_score") @db.Decimal(3, 2)

  // Publication
  readyForSubmission Boolean @default(false) @map("ready_for_submission")

  @@index([sessionId])
  @@index([reportType])
  @@index([readyForSubmission])
  @@map("maac_academic_reports")
}

// =============================================================================
// BILLING & USER MANAGEMENT MODELS
// =============================================================================

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  credits   Int      @default(0) // Credit balance (1 credit = $0.001 USD)
  
  // Relations
  experimentScenarios MAACExperimentScenario[]
  creditTransactions  CreditTransaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
  @@map("users")
}

model CreditTransaction {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        TransactionType
  amount      Int             // Credits (positive for purchase/refund, negative for usage)
  description String
  
  // JSON metadata for detailed tracking
  metadata    Json?   // { experimentId, tier, provider, model, inputTokens, outputTokens }
  
  // Stripe payment info (for purchases)
  stripePaymentIntentId String? @unique @map("stripe_payment_intent_id")
  stripeCheckoutSessionId String? @unique @map("stripe_checkout_session_id")
  
  createdAt   DateTime @default(now())
  
  @@index([userId, createdAt])
  @@index([type])
  @@index([stripePaymentIntentId])
  @@map("credit_transactions")
}

enum TransactionType {
  PURCHASE    // User bought credits
  USAGE       // Credits consumed by experiment
  REFUND      // Credits returned
  ADJUSTMENT  // Manual admin adjustment
}
